import ExcelJS from 'exceljs';
import { jsPDF } from 'jspdf';
import html2canvas from 'html2canvas';
import { saveAs } from 'file-saver';
import autoTable from 'jspdf-autotable';

// --- Excel Export with Professional Design ---
export const exportToExcel = async (items, totalSum, clientInfo) => {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Коммерческое предложение');

    const colors = {
        primary: 'FF00b4d8',
        primaryDark: 'FF0096c7',
        secondary: 'FF003366',
        lightGray: 'FFF8F9FA',
        mediumGray: 'FFE9ECEF',
        darkGray: 'FF6C757D',
        white: 'FFFFFFFF'
    };

    worksheet.pageSetup = {
        paperSize: 9,
        orientation: 'portrait',
        fitToPage: true,
        fitToWidth: 1,
        fitToHeight: 0,
        margins: {
            left: 0.7, right: 0.7,
            top: 0.75, bottom: 0.75,
            header: 0.3, footer: 0.3
        }
    };

    worksheet.columns = [
        { width: 50 },
        { width: 10 },
        { width: 10 },
        { width: 15 },
        { width: 15 }
    ];

    let currentRow = 1;

    const titleRow = worksheet.getRow(currentRow);
    titleRow.height = 30;
    worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
    const titleCell = worksheet.getCell(`A${currentRow}`);
    titleCell.value = 'MOS-POOL';
    titleCell.font = { name: 'Arial', size: 24, bold: true, color: { argb: colors.primary } };
    titleCell.alignment = { vertical: 'middle', horizontal: 'left' };
    currentRow++;

    worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
    const subtitleCell = worksheet.getCell(`A${currentRow}`);
    subtitleCell.value = 'ПРОФЕССИОНАЛЬНОЕ СТРОИТЕЛЬСТВО БАССЕЙНОВ';
    subtitleCell.font = { name: 'Arial', size: 10, color: { argb: colors.darkGray } };
    subtitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
    currentRow += 2;

    worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
    const docTitleCell = worksheet.getCell(`A${currentRow}`);
    docTitleCell.value = 'КОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ';
    docTitleCell.font = { name: 'Arial', size: 18, bold: true, color: { argb: colors.secondary } };
    docTitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
    currentRow++;

    worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
    const dateCell = worksheet.getCell(`A${currentRow}`);
    dateCell.value = `Дата: ${new Date().toLocaleDateString('ru-RU')}`;
    dateCell.font = { name: 'Arial', size: 10, color: { argb: colors.darkGray } };
    dateCell.alignment = { vertical: 'middle', horizontal: 'left' };
    currentRow += 2;

    worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
    const managerHeaderCell = worksheet.getCell(`A${currentRow}`);
    managerHeaderCell.value = 'ВАШ МЕНЕДЖЕР';
    managerHeaderCell.font = { name: 'Arial', size: 9, bold: true, color: { argb: colors.darkGray } };
    managerHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.lightGray } };
    managerHeaderCell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
    managerHeaderCell.border = {
        top: { style: 'thin', color: { argb: colors.mediumGray } },
        left: { style: 'thin', color: { argb: colors.mediumGray } },
        right: { style: 'thin', color: { argb: colors.mediumGray } }
    };

    worksheet.mergeCells(`D${currentRow}:E${currentRow}`);
    const clientHeaderCell = worksheet.getCell(`D${currentRow}`);
    clientHeaderCell.value = 'ЗАКАЗЧИК';
    clientHeaderCell.font = { name: 'Arial', size: 9, bold: true, color: { argb: colors.darkGray } };
    clientHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.lightGray } };
    clientHeaderCell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
    clientHeaderCell.border = {
        top: { style: 'thin', color: { argb: colors.mediumGray } },
        left: { style: 'thin', color: { argb: colors.mediumGray } },
        right: { style: 'thin', color: { argb: colors.mediumGray } }
    };
    currentRow++;

    worksheet.mergeCells(`A${currentRow}:B${currentRow + 2}`);
    const managerCell = worksheet.getCell(`A${currentRow}`);
    managerCell.value = 'Платон\nЯ буду сопровождать ваш проект\n+7 (919) 296-16-47';
    managerCell.font = { name: 'Arial', size: 10 };
    managerCell.alignment = { vertical: 'top', horizontal: 'left', wrapText: true };
    managerCell.border = {
        left: { style: 'thin', color: { argb: colors.mediumGray } },
        right: { style: 'thin', color: { argb: colors.mediumGray } },
        bottom: { style: 'thin', color: { argb: colors.mediumGray } }
    };

    worksheet.mergeCells(`D${currentRow}:E${currentRow + 2}`);
    const clientCell = worksheet.getCell(`D${currentRow}`);
    const clientName = clientInfo?.name || 'Клиент';
    const clientPhone = clientInfo?.phone || '';
    clientCell.value = `${clientName}\n${clientPhone}`;
    clientCell.font = { name: 'Arial', size: 10 };
    clientCell.alignment = { vertical: 'top', horizontal: 'left', wrapText: true };
    clientCell.border = {
        left: { style: 'thin', color: { argb: colors.mediumGray } },
        right: { style: 'thin', color: { argb: colors.mediumGray } },
        bottom: { style: 'thin', color: { argb: colors.mediumGray } }
    };

    currentRow += 4;

    const headerRow = worksheet.getRow(currentRow);
    headerRow.height = 25;
    headerRow.values = ['Наименование', 'Ед. изм.', 'Кол-во', 'Цена', 'Сумма'];
    headerRow.font = { name: 'Arial', size: 11, bold: true, color: { argb: colors.white } };
    headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.primary } };
    headerRow.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
    headerRow.eachCell((cell) => {
        cell.border = {
            top: { style: 'thin', color: { argb: colors.white } },
            left: { style: 'thin', color: { argb: colors.white } },
            bottom: { style: 'thin', color: { argb: colors.white } },
            right: { style: 'thin', color: { argb: colors.white } }
        };
    });
    currentRow++;

    let currentCategory = '';
    items.forEach((item, index) => {
        if (item.category !== currentCategory) {
            currentCategory = item.category;
            const categoryRow = worksheet.getRow(currentRow);
            categoryRow.height = 20;
            worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
            const categoryCell = worksheet.getCell(`A${currentRow}`);
            categoryCell.value = item.category;
            categoryCell.font = { name: 'Arial', size: 11, bold: true, color: { argb: colors.white } };
            categoryCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.primaryDark } };
            categoryCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };
            categoryCell.border = {
                top: { style: 'thin', color: { argb: colors.mediumGray } },
                left: { style: 'thin', color: { argb: colors.mediumGray } },
                bottom: { style: 'thin', color: { argb: colors.mediumGray } },
                right: { style: 'thin', color: { argb: colors.mediumGray } }
            };
            currentRow++;
        }

        const itemRow = worksheet.getRow(currentRow);
        itemRow.height = 18;
        itemRow.values = [
            item.name,
            item.unit || 'шт',
            item.quantity,
            item.price,
            item.total
        ];

        const bgColor = index % 2 === 0 ? colors.white : colors.lightGray;
        itemRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
            cell.font = { name: 'Arial', size: 10 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bgColor } };
            cell.border = {
                top: { style: 'thin', color: { argb: colors.mediumGray } },
                left: { style: 'thin', color: { argb: colors.mediumGray } },
                bottom: { style: 'thin', color: { argb: colors.mediumGray } },
                right: { style: 'thin', color: { argb: colors.mediumGray } }
            };

            if (colNumber === 1) {
                cell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1, wrapText: true };
            } else if (colNumber === 2) {
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
            } else {
                cell.alignment = { vertical: 'middle', horizontal: 'right' };
            }

            if (colNumber === 4 || colNumber === 5) {
                cell.numFmt = '#,##0 ₽';
            }
        });

        currentRow++;
    });

    currentRow++;
    const totalRow = worksheet.getRow(currentRow);
    totalRow.height = 25;
    worksheet.mergeCells(`A${currentRow}:D${currentRow}`);
    const totalLabelCell = worksheet.getCell(`A${currentRow}`);
    totalLabelCell.value = 'ИТОГО:';
    totalLabelCell.font = { name: 'Arial', size: 12, bold: true, color: { argb: colors.white } };
    totalLabelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.secondary } };
    totalLabelCell.alignment = { vertical: 'middle', horizontal: 'right', indent: 1 };
    totalLabelCell.border = {
        top: { style: 'medium', color: { argb: colors.secondary } },
        left: { style: 'medium', color: { argb: colors.secondary } },
        bottom: { style: 'medium', color: { argb: colors.secondary } },
        right: { style: 'medium', color: { argb: colors.secondary } }
    };

    const totalValueCell = worksheet.getCell(`E${currentRow}`);
    totalValueCell.value = totalSum;
    totalValueCell.font = { name: 'Arial', size: 12, bold: true, color: { argb: colors.white } };
    totalValueCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.secondary } };
    totalValueCell.alignment = { vertical: 'middle', horizontal: 'right' };
    totalValueCell.numFmt = '#,##0 ₽';
    totalValueCell.border = {
        top: { style: 'medium', color: { argb: colors.secondary } },
        left: { style: 'medium', color: { argb: colors.secondary } },
        bottom: { style: 'medium', color: { argb: colors.secondary } },
        right: { style: 'medium', color: { argb: colors.secondary } }
    };

    currentRow += 3;
    worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
    const signCell1 = worksheet.getCell(`A${currentRow}`);
    signCell1.value = 'Заказчик ___________________';
    signCell1.font = { name: 'Arial', size: 10 };
    signCell1.alignment = { vertical: 'middle', horizontal: 'left' };

    worksheet.mergeCells(`D${currentRow}:E${currentRow}`);
    const signCell2 = worksheet.getCell(`D${currentRow}`);
    signCell2.value = 'Исполнитель ______________';
    signCell2.font = { name: 'Arial', size: 10 };
    signCell2.alignment = { vertical: 'middle', horizontal: 'right' };

    worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
    const titleCell = worksheet.getCell(`A${currentRow}`);
    titleCell.value = 'MOS-POOL';
    titleCell.font = { name: 'Arial', size: 24, bold: true, color: { argb: colors.primary } };
    titleCell.alignment = { vertical: 'middle', horizontal: 'left' };
    currentRow++;

    worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
    const subtitleCell = worksheet.getCell(`A${currentRow}`);
    subtitleCell.value = 'ПРОФЕССИОНАЛЬНОЕ СТРОИТЕЛЬСТВО БАССЕЙНОВ';
    subtitleCell.font = { name: 'Arial', size: 10, color: { argb: colors.darkGray } };
    subtitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
    currentRow += 2;

    worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
    const docTitleCell = worksheet.getCell(`A${currentRow}`);
    docTitleCell.value = 'КОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ';
    docTitleCell.font = { name: 'Arial', size: 18, bold: true, color: { argb: colors.secondary } };
    docTitleCell.alignment = { vertical: 'middle', horizontal: 'left' };
    currentRow++;

    worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
    const dateCell = worksheet.getCell(`A${currentRow}`);
    dateCell.value = `Дата: ${new Date().toLocaleDateString('ru-RU')}`;
    dateCell.font = { name: 'Arial', size: 10, color: { argb: colors.darkGray } };
    dateCell.alignment = { vertical: 'middle', horizontal: 'left' };
    currentRow += 2;

    worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
    const managerHeaderCell = worksheet.getCell(`A${currentRow}`);
    managerHeaderCell.value = 'ВАШ МЕНЕДЖЕР';
    managerHeaderCell.font = { name: 'Arial', size: 9, bold: true, color: { argb: colors.darkGray } };
    managerHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.lightGray } };
    managerHeaderCell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
    managerHeaderCell.border = {
        top: { style: 'thin', color: { argb: colors.mediumGray } },
        left: { style: 'thin', color: { argb: colors.mediumGray } },
        right: { style: 'thin', color: { argb: colors.mediumGray } }
    };

    worksheet.mergeCells(`D${currentRow}:E${currentRow}`);
    const clientHeaderCell = worksheet.getCell(`D${currentRow}`);
    clientHeaderCell.value = 'ЗАКАЗЧИК';
    clientHeaderCell.font = { name: 'Arial', size: 9, bold: true, color: { argb: colors.darkGray } };
    clientHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.lightGray } };
    clientHeaderCell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
    clientHeaderCell.border = {
        top: { style: 'thin', color: { argb: colors.mediumGray } },
        left: { style: 'thin', color: { argb: colors.mediumGray } },
        right: { style: 'thin', color: { argb: colors.mediumGray } }
    };
    currentRow++;

    worksheet.mergeCells(`A${currentRow}:B${currentRow + 2}`);
    const managerCell = worksheet.getCell(`A${currentRow}`);
    managerCell.value = 'Платон\nЯ буду сопровождать ваш проект\n+7 (919) 296-16-47';
    managerCell.font = { name: 'Arial', size: 10 };
    managerCell.alignment = { vertical: 'top', horizontal: 'left', wrapText: true };
    managerCell.border = {
        left: { style: 'thin', color: { argb: colors.mediumGray } },
        right: { style: 'thin', color: { argb: colors.mediumGray } },
        bottom: { style: 'thin', color: { argb: colors.mediumGray } }
    };

    worksheet.mergeCells(`D${currentRow}:E${currentRow + 2}`);
    const clientCell = worksheet.getCell(`D${currentRow}`);
    const clientName = clientInfo?.name || 'Клиент';
    const clientPhone = clientInfo?.phone || '';
    clientCell.value = `${clientName}\n${clientPhone}`;
    clientCell.font = { name: 'Arial', size: 10 };
    clientCell.alignment = { vertical: 'top', horizontal: 'left', wrapText: true };
    clientCell.border = {
        left: { style: 'thin', color: { argb: colors.mediumGray } },
        right: { style: 'thin', color: { argb: colors.mediumGray } },
        bottom: { style: 'thin', color: { argb: colors.mediumGray } }
    };

    currentRow += 4;

    const headerRow = worksheet.getRow(currentRow);
    headerRow.height = 25;
    headerRow.values = ['Наименование', 'Ед. изм.', 'Кол-во', 'Цена', 'Сумма'];
    headerRow.font = { name: 'Arial', size: 11, bold: true, color: { argb: colors.white } };
    headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.primary } };
    headerRow.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
    headerRow.eachCell((cell) => {
        cell.border = {
            top: { style: 'thin', color: { argb: colors.white } },
            left: { style: 'thin', color: { argb: colors.white } },
            bottom: { style: 'thin', color: { argb: colors.white } },
            right: { style: 'thin', color: { argb: colors.white } }
        };
    });
    currentRow++;

    let currentCategory = '';
    items.forEach((item, index) => {
        if (item.category !== currentCategory) {
            currentCategory = item.category;
            const categoryRow = worksheet.getRow(currentRow);
            categoryRow.height = 20;
            worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
            const categoryCell = worksheet.getCell(`A${currentRow}`);
            categoryCell.value = item.category;
            categoryCell.font = { name: 'Arial', size: 11, bold: true, color: { argb: colors.white } };
            categoryCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.primaryDark } };
            categoryCell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };
            categoryCell.border = {
                top: { style: 'thin', color: { argb: colors.mediumGray } },
                left: { style: 'thin', color: { argb: colors.mediumGray } },
                bottom: { style: 'thin', color: { argb: colors.mediumGray } },
                right: { style: 'thin', color: { argb: colors.mediumGray } }
            };
            currentRow++;
        }

        const itemRow = worksheet.getRow(currentRow);
        itemRow.height = 18;
        itemRow.values = [
            item.name,
            item.unit || 'шт',
            item.quantity,
            item.price,
            item.total
        ];

        const bgColor = index % 2 === 0 ? colors.white : colors.lightGray;
        itemRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
            cell.font = { name: 'Arial', size: 10 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bgColor } };
            cell.border = {
                top: { style: 'thin', color: { argb: colors.mediumGray } },
                left: { style: 'thin', color: { argb: colors.mediumGray } },
                bottom: { style: 'thin', color: { argb: colors.mediumGray } },
                right: { style: 'thin', color: { argb: colors.mediumGray } }
            };

            if (colNumber === 1) {
                cell.alignment = { vertical: 'middle', horizontal: 'left', indent: 1, wrapText: true };
            } else if (colNumber === 2) {
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
            } else {
                cell.alignment = { vertical: 'middle', horizontal: 'right' };
            }

            if (colNumber === 4 || colNumber === 5) {
                cell.numFmt = '#,##0 ₽';
            }
        });

        currentRow++;
    });

    currentRow++;
    const totalRow = worksheet.getRow(currentRow);
    totalRow.height = 25;
    worksheet.mergeCells(`A${currentRow}:D${currentRow}`);
    const totalLabelCell = worksheet.getCell(`A${currentRow}`);
    totalLabelCell.value = 'ИТОГО:';
    totalLabelCell.font = { name: 'Arial', size: 12, bold: true, color: { argb: colors.white } };
    totalLabelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.secondary } };
    totalLabelCell.alignment = { vertical: 'middle', horizontal: 'right', indent: 1 };
    totalLabelCell.border = {
        top: { style: 'medium', color: { argb: colors.secondary } },
        left: { style: 'medium', color: { argb: colors.secondary } },
        bottom: { style: 'medium', color: { argb: colors.secondary } },
        right: { style: 'medium', color: { argb: colors.secondary } }
    };

    const totalValueCell = worksheet.getCell(`E${currentRow}`);
    totalValueCell.value = totalSum;
    totalValueCell.font = { name: 'Arial', size: 12, bold: true, color: { argb: colors.white } };
    totalValueCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.secondary } };
    totalValueCell.alignment = { vertical: 'middle', horizontal: 'right' };
    totalValueCell.numFmt = '#,##0 ₽';
    totalValueCell.border = {
        top: { style: 'medium', color: { argb: colors.secondary } },
        left: { style: 'medium', color: { argb: colors.secondary } },
        bottom: { style: 'medium', color: { argb: colors.secondary } },
        right: { style: 'medium', color: { argb: colors.secondary } }
    };

    currentRow += 3;
    worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
    const signCell1 = worksheet.getCell(`A${currentRow}`);
    signCell1.value = 'Заказчик ___________________';
    signCell1.font = { name: 'Arial', size: 10 };
    signCell1.alignment = { vertical: 'middle', horizontal: 'left' };

    worksheet.mergeCells(`D${currentRow}:E${currentRow}`);
    const signCell2 = worksheet.getCell(`D${currentRow}`);
    signCell2.value = 'Исполнитель ______________';
    signCell2.font = { name: 'Arial', size: 10 };
    signCell2.alignment = { vertical: 'middle', horizontal: 'right' };

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    saveAs(blob, `Смета_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '-')}.xlsx`);
};


// PDF Export - Using image-based approach for Cyrillic
export const exportToPDF = async (items, totalSum, clientInfo) => {
    try {
        // Create a hidden div with the content
        const container = document.createElement('div');
        container.style.cssText = 'position: absolute; left: -9999px; width: 794px; background: white; padding: 40px;';

        container.innerHTML = `
            <div style="font-family: Arial, sans-serif; color: #000000;">
                <div style="background: #f5f7fa; padding: 20px; margin: -40px -40px 30px -40px;">
                    <h1 style="color: #0071e3; font-size: 32px; margin: 0;">MOS-POOL</h1>
                    <p style="color: #666666; font-size: 12px; margin: 5px 0 0 0;">ПРОФЕССИОНАЛЬНОЕ СТРОИТЕЛЬСТВО БАССЕЙНОВ</p>
                </div>
                
                <div style="text-align: right; margin-bottom: 20px;">
                    <div style="display: inline-block; border: 1px solid #dcdce1; padding: 10px; border-radius: 8px;">
                        <p style="color: #666666; font-size: 10px; margin: 0;">ДОКУМЕНТ №</p>
                        <p style="font-size: 14px; font-weight: bold; margin: 5px 0; color: #000000;">${Date.now().toString().slice(-6)}</p>
                        <p style="color: #666666; font-size: 10px; margin: 0;">${new Date().toLocaleDateString('ru-RU')}</p>
                    </div>
                </div>
                
                <h2 style="color: #0071e3; font-size: 24px; margin: 30px 0 20px 0;">КОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ</h2>
                
                <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                    <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <p style="color: #666666; font-size: 10px; font-weight: bold; margin: 0 0 10px 0;">ВАШ МЕНЕДЖЕР</p>
                        <p style="font-size: 14px; font-weight: bold; margin: 0; color: #000000;">${clientInfo?.managerName || 'Платон'}</p>
                        <p style="font-size: 12px; margin: 5px 0 0 0; color: #000000;">Тел: ${clientInfo?.managerPhone || '+7 (919) 296-16-47'}</p>
                    </div>
                    <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <p style="color: #666666; font-size: 10px; font-weight: bold; margin: 0 0 10px 0;">ЗАКАЗЧИК</p>
                        <p style="font-size: 14px; font-weight: bold; margin: 0; color: #000000;">${clientInfo?.name || ''}</p>
                        <p style="font-size: 12px; margin: 5px 0 0 0; color: #000000;">${clientInfo?.phone || ''}</p>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background: #0071e3; color: white;">
                            <th style="padding: 12px; text-align: left; font-size: 12px;">Наименование</th>
                            <th style="padding: 12px; text-align: center; font-size: 12px; width: 60px;">Ед.</th>
                            <th style="padding: 12px; text-align: center; font-size: 12px; width: 60px;">Кол-во</th>
                            <th style="padding: 12px; text-align: right; font-size: 12px; width: 100px;">Цена (₽)</th>
                            <th style="padding: 12px; text-align: right; font-size: 12px; width: 100px;">Сумма (₽)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, index) => `
                            <tr style="background: ${index % 2 === 0 ? 'white' : '#f8f9fa'};">
                                <td style="padding: 10px; border-bottom: 1px solid #e9ecef; font-size: 11px; color: #000000;">${item.name}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #e9ecef; text-align: center; font-size: 11px; color: #000000;">${item.unit || 'шт'}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #e9ecef; text-align: center; font-size: 11px; color: #000000;">${item.quantity}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #e9ecef; text-align: right; font-size: 11px; color: #000000;">${(item.price || 0).toLocaleString('ru-RU')}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #e9ecef; text-align: right; font-size: 11px; color: #000000;">${((item.price || 0) * (item.quantity || 1)).toLocaleString('ru-RU')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr style="background: #0071e3; color: white;">
                            <td colspan="4" style="padding: 15px; text-align: right; font-size: 14px; font-weight: bold;">ИТОГО:</td>
                            <td style="padding: 15px; text-align: right; font-size: 14px; font-weight: bold;">${totalSum.toLocaleString('ru-RU')}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div style="margin-top: 40px; display: flex; justify-content: space-between;">
                    <p style="color: #666666; font-size: 12px;">Подпись заказчика: ___________________</p>
                    <p style="color: #666666; font-size: 12px;">Подпись менеджера: ___________________</p>
                </div>
            </div>
        `;

        document.body.appendChild(container);

        // Convert to canvas
        const canvas = await html2canvas(container, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        });

        document.body.removeChild(container);

        // Create PDF from canvas
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

        pdf.save(`Смета_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '-')}.pdf`);
    } catch (error) {
        console.error('PDF Export Error:', error);
        throw error;
    }
};
